{include file='public/header,public/left,public/top,public/rightStart' /}


<div class="x_content">
    <div class="x_content">
        <br>
        <form  class="form-horizontal form-label-left" novalidate>
            <input type="hidden" name="id" value="{$data|output='aid'}">
            <input type="hidden" name="uid" value="{$data|output='I_userID'}">
            <input type="hidden" name="projname" value="{$data|output='Vc_name'}">
            <input type="hidden" name="projstatus" value="{$data|output='Vc_contractSn'}">

            <div class="item form-group">
                <label class="control-label col-md-3 col-sm-3 col-xs-12">项目名称</label>
                <h5 class="col-md-6 col-sm-6 col-xs-12">
                    {$data|output='projname'}
                </h5>
            </div>
            <div class="item form-group">
                <label class="control-label col-md-3 col-sm-3 col-xs-12">企业类型</label>
                <h5 class="col-md-6 col-sm-6 col-xs-12">
                    {$data|output='orgname'}
                </h5>
            </div>
            <div class="item form-group">
                <label class="control-label col-md-3 col-sm-3 col-xs-12">项目地址</label>
                <h5 class="col-md-6 col-sm-6 col-xs-12">
                  {$data.proname}{$data.cityname}{$data.areaname}{$data.projaddr}
                </h5>
            </div>
           <div class="item form-group">
                <label class="control-label col-md-3 col-sm-3 col-xs-12" > 项目周期</label>
                <h5 class="col-md-6 col-sm-6 col-xs-12">
                    {$data.D_start}——{$data.D_end}
                </h5>
            </div>
           <div class="item form-group">
                <label class="control-label col-md-3 col-sm-3 col-xs-12" > 开发面积</label>
                <h5 class="col-md-6 col-sm-6 col-xs-12">
                    {$data.N_usearea} ㎡
                </h5>
            </div>
           <div class="item form-group">
                <label class="control-label col-md-3 col-sm-3 col-xs-12" > 预计用量</label>
                <h5 class="col-md-6 col-sm-6 col-xs-12">
                    {$data.N_weight} 吨
                </h5>
            </div>
            
           <div class="item form-group">
                <label class="control-label col-md-3 col-sm-3 col-xs-12" > 申请额度</label>
                <h5 class="col-md-6 col-sm-6 col-xs-12">
                    {$data.N_loan_amount==null?'—':$data.N_loan_amount.'万元'}
                </h5>
            </div>
            
           <div class="item form-group">
                <label class="control-label col-md-3 col-sm-3 col-xs-12" > 垫资期限</label>
                <h5 class="col-md-6 col-sm-6 col-xs-12">
                    {$data.I_loan_life==null?'—':$data.I_loan_life.'天'}
                </h5>
            </div>
            
         
           <div class="item form-group">
                <label class="control-label col-md-3 col-sm-3 col-xs-12" > 联系人</label>
             <div class="col-md-6 col-sm-6 col-xs-12">    
              {volist name="$contacts" id="vo"}
               <h5>
              <ul class="list-inline">
              	<li><i class="fa fa-user fa-fw"></i>{$vo.Vc_contactName}</li>
              	<li><i class="fa fa-phone fa-fw"></i>{$vo.Vc_phone}</li>
              
              </ul>
                </h5>
             
             {/volist}
              </div>
            </div>
           
           
            <div class="item form-group" }>
                <label class="control-label col-md-3 col-sm-3 col-xs-12">申请时间</label>
                <h5 class="col-md-6 col-sm-6 col-xs-12">
                    {$data|output='applytime'}
                </h5>
            </div>
          
             <div class="item form-group" }>
                <label class="control-label col-md-3 col-sm-3 col-xs-12">审核时间</label>
                <h5 class="col-md-6 col-sm-6 col-xs-12">
                    {$data|output='D_checktime'}
                </h5>
            </div>
             <div class="item form-group" }>
                <label class="control-label col-md-3 col-sm-3 col-xs-12">项目关闭时间</label>
                <h5 class="col-md-6 col-sm-6 col-xs-12">
                    {$data|output='D_closetime'}
                </h5>
            </div>
             <div class="item form-group" }>
                <label class="control-label col-md-3 col-sm-3 col-xs-12">首次下单时间</label>
                <h5 class="col-md-6 col-sm-6 col-xs-12">
                    {$data|output='D_firstorder_time'}
                </h5>
            </div>
           <div class="item form-group" }>
                <label class="control-label col-md-3 col-sm-3 col-xs-12">项目编号</label>
                <div class="col-md-3 col-sm-4 col-xs-6">
                  <input name="Vc_code" value="{$data|output='Vc_code'}" {if condition="!empty($data.Vc_code)&&in_array($data.I_status, [2,4,5])"}readonly="readonly"{/if} class=" form-control " required="required" type="text">
    
                </div>
            </div>
            
            <div class="item form-group" }>
                <label class="control-label col-md-3 col-sm-3 col-xs-12">合同文件</label>
               <!--  <div class="col-md-3 col-sm-4 col-xs-6">
                  <input name="Vc_contractfile" value="{$data|output='Vc_contractfile'}" class=" form-control " required="required" type="text">
    
                </div> -->
                <div class="col-md-6 col-sm-6 col-xs-12">
		                    <span class="btn btn-success fileinput-button">
		                        <i class="fa  fa-plus"></i>
		                        <span>选择文件</span>
		                        <input type="file" name="Vc_contractfile_file" x-file-up />
		                        <input type="hidden" x-file-input name="Vc_contractfile" value="{$data|output='Vc_contractfile'}" />
		                    </span>
                                <div class="fileContainer"></div>
                          合同格式:word/pdf/png或jpeg图片
                 </div>
                 
            </div>
          {if condition="!empty($data.Vc_contractSn)"}
           
            <div class="item form-group" }>
                <label class="control-label col-md-3 col-sm-3 col-xs-12">合同详细信息</label>
                <h5 class="col-md-6 col-sm-6 col-xs-12">
	              <ul class="list-unstyled">
	              	<li><i class="fa fa-briefcase fa-fw"></i> 合同编号：{$data.Vc_contractSn}</li>
	              	<li><i class="fa fa-file-text fa-fw"></i> 合同项目名称：{$data.Vc_ct_name}</li>
	              	<li><i class="fa fa-map-marker fa-fw"></i> 合同项目地址：{$data.Vc_address}</li>
	              	<li><i class="fa fa-university fa-fw"></i> 合同签约公司：{$data.company==null?'erp暂未同步到公司信息':$data.company}</li>
	              	<li><i class="fa fa-jpy fa-fw"></i> 合同总金额(万元)：{$data.N_ct_totalprice}</li>
	                <li><i class="fa fa-signal fa-fw"></i> 最高垫资金额(万元)：{$data.N_loan_maxprice}</li>
	                <li><i class="fa fa-calendar-o fa-fw"></i> 垫资期限(天)：{$data.I_ct_loan_life}</li>
	                <li><i class="fa fa-jpy fa-fw"></i> 当前可用余额(万元)：{$data.N_usable_loan}</li>
	                <li><i class="fa fa-cubes fa-fw"></i> 合同总量(吨)：{$data.N_ct_totalweight}</li>
	                <li><i class="fa fa-truck fa-fw"></i> 交货方式：{$data.Vc_delivery_type}</li>
	                <li><i class="fa fa-binoculars fa-fw"></i> 约定钢厂：{$data.Vc_ct_factory}</li>
	                <li><i class="fa fa-user fa-fw"></i> 业务员：{$data.Vc_emp}</li>
	                <li><i class="fa fa-calendar fa-fw"></i> 签约日期：{$data.D_signdate}</li>
	                <li><i class="fa fa-plus-square fa-fw"></i> 加价条件：{$data.Vc_plusprice_type}</li>
	                <li><i class="fa fa-gavel fa-fw"></i> 违约责任：{$data.Vc_dutyinfo}</li>
	                <li><i class="fa fa-tag fa-fw"></i> 备注：{$data.T_note}</li>
	                
	              </ul>
                </h5>
            </div>
            {/if}
         
         
         
            
            <div class="item form-group">
		         <label class="control-label col-md-3 col-sm-3 col-xs-12">审核状态 <span class="required">*</span></label>
		         <div class="col-md-6 col-sm-6 col-xs-12">
		             <div class="radio pull-left">
		               <label>
		                 <input value="1" name="approved" type="radio" class="flat "  {if condition="(isetn($data.I_status)==1)"}checked{/if}> 不通过
		               </label>
		             </div>
		             <div class="radio pull-left">
		               <label>
		                 <input value="2" name="approved" type="radio" class="flat " {if condition="(isetn($data.I_status)==2)"}checked{/if}> 通过
		               </label>
		             </div>
		             <div class="radio pull-left">
		               <label>
		                 <input value="4" name="approved" type="radio" class="flat " {if condition="(isetn($data.I_status)==4)"}checked{/if}> 关闭
		               </label>
		             </div>
		             <div class="radio pull-left">
		               <label>
		                 <input value="5" name="approved" type="radio" class="flat " {if condition="(isetn($data.I_status)==5)"}checked{/if}> 已完成
		               </label>
		             </div>
		           
		         </div>
     		</div>
            
            <div class="clearfix"></div>
            <div class="ln_solid"></div>
            <div class="form-group">
                <div class="col-md-6 col-sm-6 col-xs-12 col-md-offset-3">
                    <button type="button" class="btn btn-sub btn-success">确认</button>
					<a href="javascript:history.back(-1)" class="btn btn-danger">取消</a>
                </div>
            </div>

        </form>
    </div>
</div>


{include file='public/rightEnd,public/footer' /}

<script type="text/javascript">
    $(document).ready(function(){
    	 
    	  var $form = $('form'),  url = "{:url('/admin/file_upload/doUpload')}" ,
           uploadButton = $('<button onclick="return false;"/>')
                   .addClass('btn btn-primary')
                   .prop('disabled', true)
                   .text('处理中...')
                   .on('click', function () {
                       var $this = $(this),
                               data = $this.data();
                       $this
                               .off('click')
                               .text('Abort')
                               .on('click', function () {
                                   $this.remove();
                                   data.abort();
                               });
                       data.submit().always(function () {
                           $this.remove();
                       });
                   });
		   deleteButton = $('<button onclick="return false;"/>')
		           .addClass('btn btn-danger')
		           .text('删除')
		           .on('click', function () {
		               var $this = $(this) ;
		              // console.log(this);
		               $this.parents('.form-group').find('[x-file-input]').val(-1) ;
		               $this.parents('.fileContainer').empty() ;
		           });
		   
		   
		   //文件上传
		   $('[x-file-up]').fileupload({
		       // $('input[type=file]').fileupload({
		       url: url,
		       dataType: 'json',
		       autoUpload: false,
		       acceptFileTypes: /(\.|\/)(doc?x|pdf|png|jpg|jpe?g|xls?x)$/i,
		       maxFileSize: 999000,
		       
		       disableImageResize: /Android(?!.*Chrome)|Opera/
		               .test(window.navigator.userAgent),
		       /* previewMaxWidth: 200,
		       previewMaxHeight: 200,
		       previewCrop: true */
		   }).on('fileuploadadd', function (e, data) {
		       var $dom = $('input[name="' + data.paramName + '"]')
		               .parents('.fileinput-button').next('.fileContainer') ;
		       data.context = $('<div/>').appendTo($dom.empty());
		       $.each(data.files, function (index, file) {
		           var node = $('<p/>')
		                   .append($('<span/>').text(file.name));
		           if (!index) {
		               node
		                       .append('<br>')
		                       .append(uploadButton.clone(true).data(data));
		           }
		           node.appendTo(data.context);
		       });
		   }).on('fileuploadprocessalways', function (e, data) {
		       var index = data.index,
		               file = data.files[index],
		               node = $(data.context.children()[index]);
		       if (file.preview) {
		           node
		                   .prepend('<br>')
		                   .prepend(file.preview);
		       }
		       if (file.error) {
		           node
		                   .append('<br>')
		                   .append($('<span class="text-danger"/>').text(file.error));
		       }
		       if (index + 1 === data.files.length) {
		           data.context.find('button')
		                   .text('上传')
		                   .prop('disabled', !!data.files.error);
		       }
		   }).on('fileuploadprogressall', function (e, data) {
		       var progress = parseInt(data.loaded / data.total * 100, 10);
		       $('#progress .progress-bar').css(
		               'width',
		               progress + '%'
		       );
		   }).on('fileuploaddone', function (e, data) {
		       if (data.result && data.result.code == 200) {
		           console.log(data.result.data[0]);
		    	   var img = data.result.data[0] ,
		                   inputName = $(this).attr('name').replace('_file','') ,
		                   $input = $('input[name="'+inputName+'"]') ,
		                   $dom = $(this).parents('.fileinput-button').next('.fileContainer') ,
		                   $delBtn = deleteButton.clone(true) ;
		           $input.val(img.saveName) ;
		           $dom.append($delBtn) ;
		       }
		       }) ;

    	//编辑时文件查看
    	
    	var tpl = new xxx.STemplate("<h2><a href='@{src}' target='_blank'> <i class='fa  fa-file-zip-o (alias)  fa-fw fa-2x'></i> <span>文件下载</span></a></h2>") ;
                
    	$('[x-file-input]').each(setSavedImage) ;

	    function setSavedImage () {
	        var $this = $(this) , val = $this.val() , imgHost = "{$Think.config.img_url}" ,
	                $container = $this.parents('.fileinput-button').next('.fileContainer') ,$img ;
	        if (val && val.length > 10) {
	            $img = $(tpl.update({'src':imgHost+val}).html()) ;
	            $img.appendTo($container) ;
	            // $container.after() ;
	            deleteButton.clone(true).appendTo($container) ;
	        }
	    }
    	
	    
	    
    	//业务提交
    	//$form.on('blur', 'input[required]', validator.checkField);
        $(".btn-sub").on("click", function(){
        	
        /* 	if(!validator.checkAll($form) ) {
        		return false;
        	} */
    			layer.confirm('确认审核吗？', {
    				icon: 3, 
    				btn: ['确认','取消'], //按钮
    				title:'提示',
    			}, function(index){
      				layer.close(index);
      				$.post("{:url('/admin/project/edit')}",$form.serializeArray(),
      				function(data){
      					if(null != data.msg || '' != data.msg){
      						layer.msg(data.msg);
      					}
      					
      				 	if(data.code==200){
      						setTimeout(function(){
      							//window.location.href="{:url('/admin/project/index')}";
      							location.reload();
      							},1000);
      						}

      				});
    			});

    	});

    }) ;
</script>
